<Window
    x:Class="ExplorerEx.View.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:s="clr-namespace:ExplorerEx.Selector"
    xmlns:c="clr-namespace:ExplorerEx.Converter"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:v="clr-namespace:ExplorerEx.View"
    xmlns:m="clr-namespace:ExplorerEx.Model"
    xmlns:u="clr-namespace:ExplorerEx.Utils"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:vm="clr-namespace:ExplorerEx.ViewModel"
    mc:Ignorable="d" Width="1200" Height="800" Title="ExplorerEx"
    d:DataContext="{d:DesignInstance vm:MainWindowViewModel}">

    <Grid>
        <Grid.Resources>
            <ContextMenu x:Key="DirectoryItemContextMenu" d:DataContext="{d:DesignInstance m:FileSystemItem}">
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding OpenCommand}"
                          Icon="{Binding Icon}" Header="{u:Lang Open}" FontSize="15"/>
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding OpenInNewTabCommand}"
                          Icon="{StaticResource ShareDrawingImage}" Header="{u:Lang Open_in_new_Tab}" FontSize="15"/>
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding OpenInNewWindowCommand}"
                          Icon="{StaticResource ShareDrawingImage}" Header="{u:Lang Open_in_new_Window}" FontSize="15"/>
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding ShowPropertiesCommand}"
                          Icon="{StaticResource PropertiesDrawingImage}" Header="{u:Lang Properties}" FontSize="15"/>
            </ContextMenu>

            <ContextMenu x:Key="FileItemContextMenu" d:DataContext="{d:DesignInstance m:FileSystemItem}">
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding OpenCommand}"
                          Icon="{Binding Icon}" Header="{u:Lang Open}" FontSize="15"/>
                <MenuItem Height="30" hc:IconElement.Height="18" hc:IconElement.Width="18"
                          Command="{Binding ShowPropertiesCommand}"
                          Icon="{StaticResource PropertiesDrawingImage}" Header="{u:Lang Properties}" FontSize="15"/>
            </ContextMenu>

            <c:FileSystemItemContextMenuConverter x:Key="FileSystemItemContextMenuConverter"
                                                  DirectoryContextMenu="{StaticResource DirectoryItemContextMenu}"
                                                  FileContextMenu="{StaticResource FileItemContextMenu}"/>

            <DataTemplate x:Key="FileViewHomeTemplate">
                <v:ClippingBorder Margin="10,0,10,5" CornerRadius="8" 
                                  BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}"
                                  Background="{DynamicResource RegionBrush}">
                    <ListBox d:DataContext="{d:DesignInstance vm:FileViewTabViewModel}" Margin="0,10"
                         x:Name="HomeListView" ItemsSource="{Binding Items}"
                         SelectionMode="Extended" hc:BorderElement.CornerRadius="5"
                         MouseUp="HomeListBox_OnMouseUp" Background="{x:Null}">
                        <hc:Interaction.Triggers>
                            <hc:RoutedEventTrigger RoutedEvent="ListBox.SelectionChanged">
                                <hc:EventToCommand Command="{Binding SelectionChangedCommand}" PassEventArgsToCommand="True" />
                            </hc:RoutedEventTrigger>
                        </hc:Interaction.Triggers>
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel x:Name="HomeWrapPanel" Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource ListBoxItemBaseStyle}">
                                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid x:Name="HomeDriveGrid" d:DataContext="{d:DesignInstance m:DiskDriveItem}"
                                  Height="60" Width="260" Margin="5" VerticalAlignment="Center">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="60"/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Image Grid.Column="0" Source="{Binding Icon}" VerticalAlignment="Center" Margin="5"/>
                                    <StackPanel Grid.Column="1" Orientation="Vertical">
                                        <TextBlock Text="{Binding Name, Mode=OneWay}"/>
                                        <ProgressBar Value="{Binding FreeSpaceRatio, Mode=OneWay}" Maximum="1"/>
                                        <TextBlock Text="{Binding SpaceOverviewString, Mode=OneWay}"/>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </v:ClippingBorder>
            </DataTemplate>

            <DataTemplate x:Key="FileViewDetailTemplate">
                <DataGrid d:DataContext="{d:DesignInstance vm:FileViewTabViewModel}"
                          ItemsSource="{Binding Items}"
                          SelectionMode="Extended" AutoGenerateColumns="False" RowHeight="30"
                          MouseUp="DataGrid_OnMouseUp">
                    <hc:Interaction.Triggers>
                        <hc:RoutedEventTrigger RoutedEvent="ListBox.SelectionChanged">
                            <hc:EventToCommand Command="{Binding SelectionChangedCommand}" PassEventArgsToCommand="True" />
                        </hc:RoutedEventTrigger>
                    </hc:Interaction.Triggers>
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow" BasedOn="{StaticResource DataGridRowStyle}">
                            <Setter Property="ContextMenu"
                                    Value="{Binding IsDirectory, Converter={StaticResource FileSystemItemContextMenuConverter}}"/>
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                        </Style>
                    </DataGrid.RowStyle>
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="名称" Width="600">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid Height="30" VerticalAlignment="Center" 
                                          d:DataContext="{d:DesignInstance m:FileSystemItem}"
                                          IsHitTestVisible="False">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="30"/>
                                            <ColumnDefinition/>
                                        </Grid.ColumnDefinitions>
                                        <Image Grid.Column="0" 
                                               Source="{Binding Icon}"
                                               VerticalAlignment="Center" Margin="5"/>
                                        <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="修改日期" Width="200">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock d:DataContext="{d:DesignInstance m:FileSystemItem}"
                                               Text="{Binding LastWriteTime}" 
                                               VerticalAlignment="Center"
                                               IsHitTestVisible="False"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="文件大小" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock d:DataContext="{d:DesignInstance m:FileSystemItem}"
                                               Text="{Binding FileSizeString}" 
                                               VerticalAlignment="Center"
                                               IsHitTestVisible="False"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </DataTemplate>

            <s:FileViewDataTemplateSelector x:Key="FileViewDataTemplateSelector" 
                                            FileViewDetailTemplate="{StaticResource FileViewDetailTemplate}" 
                                            FileViewHomeTemplate="{StaticResource FileViewHomeTemplate}"/>
        </Grid.Resources>

        <hc:TabControl x:Name="MainTabControl" ItemsSource="{Binding TabViewItems}"
                       IsDraggable="True" ShowCloseButton="True" IsAnimationEnabled="True" TabItemHeight="35"
                       SelectedIndex="{Binding TabViewSelectedIndex}">
            <hc:TabControl.ItemTemplate>
                <DataTemplate>
                    <TextBlock Width="200"
                               d:DataContext="{d:DesignInstance vm:FileViewTabViewModel}"
                               Text="{Binding Header}"/>
                </DataTemplate>
            </hc:TabControl.ItemTemplate>
            <hc:TabControl.ContentTemplate>
                <DataTemplate>
                    <Grid d:DataContext="{d:DesignInstance vm:FileViewTabViewModel}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Padding="15, 15, 15, 10">
                            <StackPanel x:Name="FileToolsStackPanel" Orientation="Horizontal">
                                <hc:SplitButton Padding="0" Height="35" HitMode="None" IsEnabled="{Binding CanGoToUpperLevel}">
                                    <StackPanel Orientation="Horizontal" Margin="10,5,5,5">
                                        <Image VerticalAlignment="Center" Source="{StaticResource NewDrawingImage}" Width="20" Height="20" SnapsToDevicePixels="True"/>
                                        <TextBlock Text="{u:Lang New}" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                    </StackPanel>
                                    <hc:SplitButton.DropDownContent>
                                        <Menu Margin="4,0,4,0" Width="Auto" BorderBrush="{x:Null}" 
                                              ItemsSource="{Binding CreateFileItems}">
                                            <Menu.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Vertical"/>
                                                </ItemsPanelTemplate>
                                            </Menu.ItemsPanel>
                                            <Menu.ItemTemplate>
                                                <DataTemplate>
                                                    <MenuItem Height="30" Margin="-5,0,0,0" hc:IconElement.Height="18" hc:IconElement.Width="18"
                                                              Command="{Binding CreateCommand}" 
                                                              CommandParameter="{Binding DataContext.FullPath, RelativeSource={RelativeSource AncestorType=Menu}}"
                                                              Icon="{Binding Icon}" Header="{Binding Description}" FontSize="15"/>
                                                </DataTemplate>
                                            </Menu.ItemTemplate>
                                        </Menu>
                                    </hc:SplitButton.DropDownContent>
                                </hc:SplitButton>
                                <GridSplitter Width="1" Height="30" Background="{DynamicResource SecondaryBorderBrush}" Margin="10,0,10,0"/>

                                <Button VerticalAlignment="Stretch" Height="35"
                                            IsEnabled="{Binding IsItemSelected, Mode=OneWay}">
                                    <Image Width="20" Height="20" Source="{StaticResource CutDrawingImage}"/>
                                </Button>
                                <Button VerticalAlignment="Stretch" Height="35" Margin="10,0,0,0" 
                                            IsEnabled="{Binding IsItemSelected, Mode=OneWay}">
                                    <Image Width="20" Height="20" Source="{StaticResource CopyDrawingImage}"/>
                                </Button>
                                <Button VerticalAlignment="Stretch" Height="35" Margin="10,0,0,0">
                                    <Image Width="20" Height="20" Source="{StaticResource PasteDrawingImage}"/>
                                </Button>
                                <Button VerticalAlignment="Stretch" Height="35" Margin="10,0,0,0" 
                                    IsEnabled="{Binding IsItemSelected, Mode=OneWay}">
                                    <Image Width="20" Height="20" Source="{StaticResource RenameDrawingImage}"/>
                                </Button>
                                <Button VerticalAlignment="Stretch" Height="35" Margin="10,0,0,0" 
                                            IsEnabled="{Binding IsItemSelected, Mode=OneWay}">
                                    <Image Width="20" Height="20" Source="{StaticResource ShareDrawingImage}"/>
                                </Button>
                                <Button VerticalAlignment="Stretch" Height="35" Margin="10,0,0,0" 
                                            IsEnabled="{Binding IsItemSelected, Mode=OneWay}">
                                    <Image Width="20" Height="20" Source="{StaticResource DeleteDrawingImage}"/>
                                </Button>
                                <GridSplitter Width="1" Height="30" Background="{DynamicResource SecondaryBorderBrush}" Margin="10,0,10,0"/>

                                <hc:SplitButton Padding="0" Height="35" HitMode="None">
                                    <StackPanel Orientation="Horizontal" Margin="0,5,0,5">
                                        <Image Margin="10,0,0,0" Width="20" Height="20" Source="{StaticResource SortDrawingImage}"/>
                                        <TextBlock Text="{u:Lang Sort}" VerticalAlignment="Center" Margin="7,0,5,0"/>
                                    </StackPanel>
                                </hc:SplitButton>
                                <hc:SplitButton Padding="0" Height="35" Margin="10,0,0,0" HitMode="None">
                                    <StackPanel Orientation="Horizontal" Margin="0,5,0,5">
                                        <Image Margin="10,0,0,0" Width="20" Height="20" Source="{StaticResource ListDrawingImage}"/>
                                        <TextBlock Text="{u:Lang View}" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                    </StackPanel>
                                </hc:SplitButton>
                                <GridSplitter Width="1" Height="30" Background="{DynamicResource SecondaryBorderBrush}" Margin="10,0,10,0"/>

                                <Button VerticalAlignment="Stretch" Width="45" Height="35" Padding="0">
                                    <Image Width="24" Height="24" Source="{StaticResource MoreDrawingImage}"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <Border Grid.Row="1" BorderThickness="0,1,0,0" Padding="10,5,10,5">
                            <DockPanel>
                                <Button Margin="5" hc:IconElement.Geometry="{StaticResource LeftArrowGeometry}" 
                                        IsEnabled="{Binding CanGoBack, Mode=OneWay}" 
                                        Command="{Binding GoBackCommand}"/>
                                <hc:SplitButton Margin="5" hc:IconElement.Geometry="{StaticResource RightArrowGeometry}" 
                                                IsEnabled="{Binding CanGoForward, Mode=OneWay}" 
                                                Command="{Binding GoForwardCommand}" HitMode="Click"/>
                                <Button Margin="5" hc:IconElement.Geometry="{StaticResource UpArrowGeometry}"
                                        IsEnabled="{Binding CanGoToUpperLevel, Mode=OneWay}" 
                                        Command="{Binding GoToUpperLevelCommand}"/>

                                <TextBox DockPanel.Dock="Left" x:Name="AddressBar" Width="700" Margin="5" Text="{Binding FullPath, Mode=OneWay}" KeyDown="AddressBar_OnKeyDown"/>
                                <TextBox DockPanel.Dock="Right" Margin="5"/>
                            </DockPanel>
                        </Border>

                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition Width="200"/>
                            </Grid.ColumnDefinitions>

                            <ScrollViewer Grid.Column="1">
                                <TreeView>
                                    <TreeView.ItemTemplate>
                                        <DataTemplate></DataTemplate>
                                    </TreeView.ItemTemplate>
                                </TreeView>
                            </ScrollViewer>

                            <Grid Grid.Column="0">
                                <Grid.RowDefinitions>
                                    <RowDefinition/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <ContentPresenter x:Name="FileSystemViewContentPresenter" Grid.Row="0" 
                                                  ContentTemplateSelector="{StaticResource FileViewDataTemplateSelector}"/>

                                <Border Grid.Row="1" Padding="20,0,0,0">
                                    <StackPanel Orientation="Horizontal" d:DataContext="{d:DesignInstance vm:FileViewTabViewModel}">
                                        <TextBlock>
                                            <Run Text="{Binding FileItemsCount, Mode=OneWay}"/>
                                            <Run Text="{u:Lang Run_ItemsCount}"/>
                                        </TextBlock>
                                        <GridSplitter Width="1" Height="25" Background="{DynamicResource SecondaryBorderBrush}" Margin="10,-5,10,0"/>

                                        <TextBlock Visibility="{Binding SelectedFileItemsCountVisibility, Mode=OneWay}">
                                            <Run Text="{u:Lang Run_SelectedItemsCount}"/>
                                            <Run Text="{Binding SelectedFileItemsCount, Mode=OneWay}"/>
                                            <Run Text="{u:Lang Run_ItemsCount}"/>
                                        </TextBlock>

                                        <TextBlock Margin="10,0,0,0" 
                                                   Visibility="{Binding SelectedFileItemsSizeVisibility, Mode=OneWay}"
                                                   Text="{Binding SelectedFileItemsSizeString, Mode=OneWay}"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </hc:TabControl.ContentTemplate>
        </hc:TabControl>
    </Grid>
</Window>
